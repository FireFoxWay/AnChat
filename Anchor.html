/* ===============================
   SINGLE-FILE ANONYMOUS IMAGEBOARD
   =============================== */

import express from "express";
import sqlite3 from "sqlite3";
import multer from "multer";
import bodyParser from "body-parser";
import fs from "fs";
import path from "path";

const app = express();
app.use(bodyParser.urlencoded({ extended: true }));
app.use(bodyParser.json());

/* ---------- Uploads ---------- */
if (!fs.existsSync("uploads")) fs.mkdirSync("uploads");
app.use("/uploads", express.static("uploads"));

const storage = multer.diskStorage({
  destination: "uploads/",
  filename: (_, file, cb) =>
    cb(null, Date.now() + path.extname(file.originalname))
});
const upload = multer({ storage });

/* ---------- Database ---------- */
const db = new sqlite3.Database("board.db");

db.serialize(() => {
  db.run(`
    CREATE TABLE IF NOT EXISTS threads (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      board TEXT,
      title TEXT,
      image TEXT,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP
    )
  `);

  db.run(`
    CREATE TABLE IF NOT EXISTS posts (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      thread_id INTEGER,
      content TEXT,
      image TEXT,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP
    )
  `);
});

const BOARDS = ["tech", "movies", "studies", "news"];

/* ---------- API ---------- */

app.get("/api/:board/threads", (req, res) => {
  if (!BOARDS.includes(req.params.board)) return res.sendStatus(404);
  db.all(
    "SELECT * FROM threads WHERE board=? ORDER BY created_at DESC",
    [req.params.board],
    (_, rows) => res.json(rows)
  );
});

app.post("/api/:board/thread", upload.single("image"), (req, res) => {
  db.run(
    "INSERT INTO threads(board,title,image) VALUES(?,?,?)",
    [req.params.board, req.body.title, req.file?.filename || null],
    function () {
      res.json({ id: this.lastID });
    }
  );
});

app.get("/api/thread/:id/posts", (req, res) => {
  db.all(
    "SELECT * FROM posts WHERE thread_id=?",
    [req.params.id],
    (_, rows) => res.json(rows)
  );
});

app.post("/api/thread/:id/post", upload.single("image"), (req, res) => {
  db.run(
    "INSERT INTO posts(thread_id,content,image) VALUES(?,?,?)",
    [req.params.id, req.body.content || "", req.file?.filename || null],
    () => res.json({ ok: true })
  );
});

/* ---------- FRONTEND (INLINE HTML) ---------- */

app.get("/", (_, res) => {
  res.send(`<!DOCTYPE html>
<html>
<head>
<title>Anonymous Imageboard</title>
<style>
body{font-family:Arial;background:#eee;padding:10px}
nav button{margin:4px}
.thread,.post{background:#fff;border:1px solid #ccc;margin:8px 0;padding:8px}
img{max-width:300px;margin-top:6px}
textarea{width:100%;height:80px}
</style>
</head>
<body>

<h1>Anonymous Boards</h1>
<nav>
<button onclick="load('tech')">/tech</button>
<button onclick="load('movies')">/movies</button>
<button onclick="load('studies')">/studies</button>
<button onclick="load('news')">/news</button>
</nav>

<h2 id="board"></h2>

<form id="threadForm">
<input name="title" placeholder="Thread title" required>
<input name="image" type="file">
<button>Create Thread</button>
</form>

<div id="threads"></div>

<div id="posts" style="display:none">
<h3>Replies</h3>
<div id="postList"></div>
<textarea id="replyText"></textarea><br>
<input id="replyImage" type="file">
<button onclick="reply()">Reply</button>
<button onclick="back()">Back</button>
</div>

<script>
let board="tech", threadId=null;

function load(b){
board=b;
document.getElementById("board").innerText="/"+b;
document.getElementById("posts").style.display="none";
fetch("/api/"+b+"/threads").then(r=>r.json()).then(d=>{
threads.innerHTML=d.map(t=>
'<div class="thread" onclick="open('+t.id+')"><b>'+t.title+'</b><br>'+
(t.image?'<img src="/uploads/'+t.image+'">':'')+'</div>'
).join("");
});
}

threadForm.onsubmit=e=>{
e.preventDefault();
fetch("/api/"+board+"/thread",{method:"POST",body:new FormData(e.target)})
.then(()=>{e.target.reset();load(board)});
};

function open(id){
threadId=id;
posts.style.display="block";
fetch("/api/thread/"+id+"/posts").then(r=>r.json()).then(p=>{
postList.innerHTML=p.map(x=>
'<div class="post">'+(x.content||"")+
(x.image?'<img src="/uploads/'+x.image+'">':'')+'</div>'
).join("");
});
}

function reply(){
const f=new FormData();
f.append("content",replyText.value);
f.append("image",replyImage.files[0]);
fetch("/api/thread/"+threadId+"/post",{method:"POST",body:f})
.then(()=>open(threadId));
}

function back(){posts.style.display="none";}
load(board);
</script>

</body>
</html>`);
});

/* ---------- START ---------- */
app.listen(3000, () =>
  console.log("Running â†’ http://localhost:3000")
);
